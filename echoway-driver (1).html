<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EchoWay â€” Driver App</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --g: #00FFB2;
  --g2: #00C98A;
  --amber: #FFB800;
  --red: #FF4757;
  --bg: #080F17;
  --bg2: #0D1822;
  --bg3: #142030;
  --card: rgba(255,255,255,0.04);
  --border: rgba(0,255,178,0.15);
  --text: #F0F4FF;
  --muted: #6B7A8D;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 10% 10%,rgba(0,255,178,0.06) 0%,transparent 50%),radial-gradient(ellipse at 90% 90%,rgba(255,184,0,0.04) 0%,transparent 50%);pointer-events:none;}

.header{position:sticky;top:0;z-index:100;padding:16px 20px;background:rgba(8,15,23,0.9);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.logo{display:flex;align-items:center;gap:10px;}
.logo-mark{width:38px;height:38px;background:linear-gradient(135deg,var(--g),var(--amber));border-radius:10px;display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-weight:800;font-size:18px;color:#080F17;}
.logo-text{font-family:'Syne',sans-serif;font-weight:800;font-size:22px;background:linear-gradient(90deg,var(--g),var(--amber));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.logout-btn{padding:8px 16px;background:rgba(255,71,87,0.12);border:1px solid rgba(255,71,87,0.3);color:var(--red);border-radius:20px;font-size:13px;font-weight:600;cursor:pointer;}

.main{max-width:480px;margin:0 auto;padding:20px 16px 100px;}

/* LOGIN */
.login-wrap{min-height:calc(100vh - 70px);display:flex;align-items:center;justify-content:center;padding:20px;}
.login-card{background:var(--bg2);border:1.5px solid var(--border);border-radius:24px;padding:36px 28px;width:100%;max-width:400px;}
.login-hero{font-size:56px;text-align:center;margin-bottom:20px;}
.login-title{font-family:'Syne',sans-serif;font-size:26px;font-weight:800;text-align:center;margin-bottom:6px;}
.login-sub{font-size:14px;color:var(--muted);text-align:center;margin-bottom:32px;}
.form-group{margin-bottom:18px;}
.form-label{display:block;font-size:13px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;}
select,input[type=password]{width:100%;padding:15px;background:var(--bg3);border:1.5px solid var(--border);border-radius:12px;color:var(--text);font-size:15px;font-family:'DM Sans',sans-serif;outline:none;transition:border-color 0.2s;}
select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%236B7A8D' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;cursor:pointer;}
select:focus,input[type=password]:focus{border-color:var(--g);}
select option{background:var(--bg3);}
.hint-box{background:rgba(0,255,178,0.06);border:1px solid rgba(0,255,178,0.1);border-radius:10px;padding:14px;margin-bottom:20px;}
.hint-box p{font-size:13px;color:var(--muted);margin:3px 0;}
.hint-box strong{color:var(--g);}
.login-btn{width:100%;padding:18px;background:linear-gradient(135deg,var(--g),var(--g2));color:#080F17;border:none;border-radius:14px;font-family:'Syne',sans-serif;font-size:17px;font-weight:800;cursor:pointer;letter-spacing:0.5px;}
.error-box{background:rgba(255,71,87,0.1);border:1px solid rgba(255,71,87,0.3);border-radius:10px;padding:12px;text-align:center;color:var(--red);font-size:14px;margin-bottom:16px;display:none;}

/* DASHBOARD */
.driver-profile{background:var(--bg2);border:1.5px solid var(--border);border-radius:20px;padding:22px;margin-bottom:20px;}
.profile-top{display:flex;align-items:center;gap:16px;margin-bottom:16px;}
.avatar{width:56px;height:56px;background:linear-gradient(135deg,var(--g),var(--amber));border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-size:22px;font-weight:800;color:#080F17;flex-shrink:0;}
.profile-name{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:3px;}
.profile-sub{font-size:13px;color:var(--muted);}
.stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;}
.stat-box{background:var(--bg3);border-radius:12px;padding:12px;text-align:center;}
.stat-val{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;color:var(--g);}
.stat-lbl{font-size:11px;color:var(--muted);margin-top:2px;}

/* TOGGLE */
.status-toggle{background:var(--bg2);border:1.5px solid var(--border);border-radius:16px;padding:18px 20px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;}
.toggle-title{font-family:'Syne',sans-serif;font-size:16px;font-weight:700;margin-bottom:3px;}
.toggle-sub{font-size:13px;color:var(--muted);}
.switch{width:56px;height:28px;background:#1e2d3d;border-radius:14px;cursor:pointer;position:relative;transition:background 0.3s;flex-shrink:0;}
.switch.on{background:var(--g);}
.switch::after{content:'';position:absolute;width:22px;height:22px;background:white;border-radius:50%;top:3px;left:3px;transition:left 0.3s;box-shadow:0 2px 6px rgba(0,0,0,0.3);}
.switch.on::after{left:31px;}

/* MODE */
.mode-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px;}
.mode-card{background:var(--bg2);border:1.5px solid var(--border);border-radius:14px;padding:14px;cursor:pointer;transition:all 0.25s;text-align:center;}
.mode-card.active{border-color:var(--g);background:rgba(0,255,178,0.06);}
.mode-icon{font-size:28px;margin-bottom:8px;}
.mode-name{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;margin-bottom:4px;}
.mode-desc{font-size:11px;color:var(--muted);}

/* RIDE REQUEST */
.ride-request{background:var(--bg2);border:2px solid var(--amber);border-radius:20px;padding:22px;position:relative;overflow:hidden;}
.ride-request::before{content:'';position:absolute;inset:0;background:rgba(255,184,0,0.03);pointer-events:none;}
.new-badge{display:inline-flex;align-items:center;gap:6px;background:var(--amber);color:#080F17;padding:5px 12px;border-radius:20px;font-family:'Syne',sans-serif;font-size:11px;font-weight:800;margin-bottom:16px;}
.type-badge{display:inline-block;margin-left:8px;background:rgba(0,255,178,0.1);border:1px solid rgba(0,255,178,0.2);border-radius:20px;padding:4px 12px;font-size:11px;color:var(--g);}
.cust-row{display:flex;gap:12px;align-items:center;background:var(--bg3);border-radius:12px;padding:14px;margin-bottom:14px;}
.cust-avatar{width:44px;height:44px;border-radius:50%;object-fit:cover;border:2px solid var(--g);flex-shrink:0;}
.cust-name{font-weight:600;font-size:15px;margin-bottom:2px;}
.cust-phone{font-size:13px;color:var(--muted);}
.loc-block{margin-bottom:14px;}
.loc-row{display:flex;gap:12px;padding:12px;background:var(--bg3);border-radius:10px;margin-bottom:6px;}
.loc-icon{font-size:20px;flex-shrink:0;}
.loc-lbl{font-size:11px;color:var(--muted);}
.loc-addr{font-size:14px;font-weight:600;}
.fare-big{text-align:center;background:rgba(0,255,178,0.1);border:1px solid rgba(0,255,178,0.2);border-radius:14px;padding:18px;margin:16px 0;}
.fare-big-val{font-family:'Syne',sans-serif;font-size:40px;font-weight:800;color:var(--g);}
.fare-big-sub{font-size:13px;color:var(--muted);margin-top:4px;}
.action-row{display:grid;grid-template-columns:1fr 2fr;gap:12px;}
.btn-base{padding:16px;border:none;border-radius:14px;font-family:'Syne',sans-serif;font-size:15px;font-weight:800;cursor:pointer;transition:all 0.2s;}
.btn-accept{background:linear-gradient(135deg,var(--g),var(--g2));color:#080F17;}
.btn-decline{background:rgba(255,71,87,0.12);border:1.5px solid rgba(255,71,87,0.3);color:var(--red);}
.btn-accept:hover{transform:translateY(-2px);}

/* NO RIDES */
.empty-state{text-align:center;padding:60px 20px;}
.empty-icon{font-size:64px;margin-bottom:16px;opacity:0.7;}
.empty-title{font-family:'Syne',sans-serif;font-size:20px;font-weight:700;margin-bottom:8px;}
.empty-sub{font-size:14px;color:var(--muted);}

/* NAVIGATION VIEW */
.nav-active{background:var(--bg2);border:2px solid var(--g);border-radius:20px;padding:22px;}
.nav-phase{font-family:'Syne',sans-serif;font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--g);margin-bottom:16px;}
.nav-dest{background:var(--bg3);border-radius:14px;padding:16px;margin-bottom:16px;display:flex;gap:14px;align-items:flex-start;}
.nav-dest-icon{font-size:28px;}
.nav-dest-lbl{font-size:12px;color:var(--muted);margin-bottom:4px;}
.nav-dest-addr{font-size:16px;font-weight:700;}
.nav-btn{width:100%;padding:18px;background:linear-gradient(135deg,var(--g),var(--g2));color:#080F17;border:none;border-radius:14px;font-family:'Syne',sans-serif;font-size:17px;font-weight:800;cursor:pointer;margin-bottom:10px;}
.maps-btn{width:100%;padding:14px;background:rgba(0,255,178,0.1);border:1.5px solid var(--g);color:var(--g);border-radius:12px;font-family:'Syne',sans-serif;font-size:14px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:10px;}
.call-btn{width:100%;padding:14px;background:rgba(255,184,0,0.1);border:1.5px solid var(--amber);color:var(--amber);border-radius:12px;font-family:'Syne',sans-serif;font-size:14px;font-weight:700;cursor:pointer;}

/* OTP MODAL */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);backdrop-filter:blur(8px);z-index:200;align-items:center;justify-content:center;padding:20px;}
.overlay.show{display:flex;}
.sheet{background:var(--bg2);border-radius:24px;padding:32px 24px;width:100%;max-width:380px;border:1px solid var(--border);}
.sheet-icon{font-size:52px;text-align:center;margin-bottom:16px;}
.sheet-title{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;text-align:center;margin-bottom:8px;}
.sheet-sub{font-size:14px;color:var(--muted);text-align:center;margin-bottom:24px;}
.otp-input-big{width:100%;padding:22px;font-family:'Syne',sans-serif;font-size:36px;font-weight:800;text-align:center;letter-spacing:16px;background:var(--bg3);border:2.5px solid var(--g);border-radius:16px;color:var(--text);outline:none;display:block;margin:0 auto 20px;}
.otp-input-big::placeholder{opacity:0.3;letter-spacing:8px;}
.verify-btn{width:100%;padding:18px;background:linear-gradient(135deg,var(--g),var(--g2));color:#080F17;border:none;border-radius:14px;font-family:'Syne',sans-serif;font-size:17px;font-weight:800;cursor:pointer;}
.wait-pill{background:rgba(255,184,0,0.1);border:1.5px dashed var(--amber);border-radius:14px;padding:18px;text-align:center;margin-bottom:20px;}
.wait-text{color:var(--amber);font-size:15px;font-weight:600;}
.wait-sub{color:var(--muted);font-size:13px;margin-top:4px;}

/* PAYMENT */
.pay-options{display:grid;gap:10px;margin:20px 0;}
.pay-opt{background:var(--bg3);border:1.5px solid var(--border);border-radius:14px;padding:16px;cursor:pointer;display:flex;align-items:center;gap:14px;transition:all 0.2s;}
.pay-opt:hover,.pay-opt.sel{border-color:var(--g);background:rgba(0,255,178,0.06);}
.pay-icon{font-size:28px;}
.pay-name{font-size:15px;font-weight:600;}
.pay-sub{font-size:12px;color:var(--muted);}
</style>
</head>
<body>

<div class="header">
  <div class="logo">
    <div class="logo-mark">E</div>
    <span class="logo-text">EchoWay</span>
  </div>
  <div id="headerActions"></div>
</div>

<!-- LOGIN -->
<div id="loginWrap" class="login-wrap">
  <div class="login-card">
    <div class="login-hero">ğŸ›º</div>
    <h2 class="login-title">Driver Login</h2>
    <p class="login-sub">Sign in to your partner account</p>

    <div class="error-box" id="errBox"></div>

    <div class="form-group">
      <label class="form-label">Select Your Name</label>
      <select id="driverSel">
        <option value="">â€” Choose driver â€”</option>
        <option value="vikram">Vikram Kumar Â· EW-1234</option>
        <option value="rajesh">Rajesh Singh Â· EW-2345</option>
        <option value="priya">Priya Sharma Â· EW-3456</option>
        <option value="amit">Amit Verma Â· EW-4567</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Password</label>
      <input type="password" id="driverPass" placeholder="Enter password">
    </div>
    <div class="hint-box">
      <p><strong>Passwords:</strong></p>
      <p>vikram123 Â· rajesh123 Â· priya123 Â· amit123</p>
    </div>
    <button class="login-btn" onclick="doLogin()">Login to Dashboard</button>
  </div>
</div>

<!-- DASHBOARD -->
<div class="main" id="dashboard" style="display:none;">

  <!-- Profile Card -->
  <div class="driver-profile">
    <div class="profile-top">
      <div class="avatar" id="dAvatar">--</div>
      <div>
        <div class="profile-name" id="dName">--</div>
        <div class="profile-sub" id="dMeta">--</div>
      </div>
    </div>
    <div class="stats-row">
      <div class="stat-box"><div class="stat-val" id="dRides">0</div><div class="stat-lbl">Rides Today</div></div>
      <div class="stat-box"><div class="stat-val">â‚¹<span id="dEarnings">0</span></div><div class="stat-lbl">Earnings</div></div>
      <div class="stat-box"><div class="stat-val" id="dRating">--</div><div class="stat-lbl">Rating â­</div></div>
    </div>
  </div>

  <!-- Online Toggle -->
  <div class="status-toggle">
    <div>
      <div class="toggle-title" id="tTitle">You're Online</div>
      <div class="toggle-sub" id="tSub">Ready to accept rides</div>
    </div>
    <div class="switch on" id="onlineSwitch" onclick="toggleOnline()"></div>
  </div>

  <!-- Mode Cards -->
  <div class="mode-row">
    <div class="mode-card active" id="m-app" onclick="setMode('app')">
      <div class="mode-icon">ğŸ“±</div>
      <div class="mode-name">App Rides</div>
      <div class="mode-desc">EchoWay app customers</div>
    </div>
    <div class="mode-card" id="m-street" onclick="setMode('street')">
      <div class="mode-icon">ğŸš—</div>
      <div class="mode-name">Street Rides</div>
      <div class="mode-desc">Walk-in passengers</div>
    </div>
  </div>

  <!-- Ride Section -->
  <div id="rideSection"></div>

</div>

<!-- OTP REQUEST MODAL -->
<div class="overlay" id="otpRequestOverlay">
  <div class="sheet">
    <div class="sheet-icon" id="otpReqIcon">ğŸ””</div>
    <h3 class="sheet-title" id="otpReqTitle">Waiting for OTP</h3>
    <p class="sheet-sub" id="otpReqSub">Ask customer to generate their OTP</p>
    <div class="wait-pill">
      <div class="wait-text">â³ Waiting for customer...</div>
      <div class="wait-sub" id="otpReqWait">Ask them to tap "Generate OTP" on their app</div>
    </div>
    <button class="verify-btn" onclick="checkCustomerOTP()" style="background:rgba(0,255,178,0.1);color:var(--g);border:1.5px solid var(--g);">Customer Generated OTP â†’</button>
  </div>
</div>

<!-- OTP ENTER MODAL -->
<div class="overlay" id="otpEnterOverlay">
  <div class="sheet">
    <div class="sheet-icon" id="otpIcon">ğŸ”</div>
    <h3 class="sheet-title" id="otpTitle">Enter Start OTP</h3>
    <p class="sheet-sub" id="otpSub">Enter the 4-digit OTP from the customer</p>
    <input class="otp-input-big" type="text" id="otpInput" maxlength="4" placeholder="â€¢â€¢â€¢â€¢" inputmode="numeric">
    <button class="verify-btn" onclick="verifyOTP()">Verify & Proceed</button>
  </div>
</div>

<!-- PAYMENT MODAL -->
<div class="overlay" id="payOverlay">
  <div class="sheet">
    <div class="sheet-icon">ğŸ’³</div>
    <h3 class="sheet-title">Collect Payment</h3>
    <div style="text-align:center;margin-bottom:4px;font-size:44px;font-family:'Syne',sans-serif;font-weight:800;color:var(--g)" id="payAmount">â‚¹--</div>
    <p style="text-align:center;font-size:13px;color:var(--muted);margin-bottom:20px;">Select payment method received</p>
    <div class="pay-options">
      <div class="pay-opt sel" onclick="selPay(this)"><div class="pay-icon">ğŸ’µ</div><div><div class="pay-name">Cash</div><div class="pay-sub">Physical notes & coins</div></div></div>
      <div class="pay-opt" onclick="selPay(this)"><div class="pay-icon">ğŸ“±</div><div><div class="pay-name">UPI / PhonePe / GPay</div><div class="pay-sub">Scan QR or send to number</div></div></div>
      <div class="pay-opt" onclick="selPay(this)"><div class="pay-icon">ğŸ’³</div><div><div class="pay-name">Card</div><div class="pay-sub">Debit or credit card</div></div></div>
    </div>
    <button class="verify-btn" onclick="confirmPayment()">Payment Collected âœ“</button>
  </div>
</div>

<!-- DONE MODAL -->
<div class="overlay" id="doneOverlay">
  <div class="sheet">
    <div class="sheet-icon">ğŸ‰</div>
    <h3 class="sheet-title">Ride Complete!</h3>
    <p style="text-align:center;font-size:14px;color:var(--muted);margin-bottom:12px;">Customer data securely erased</p>
    <div id="rideEarnedBox" style="background:rgba(0,255,178,0.1);border:1px solid rgba(0,255,178,0.2);border-radius:14px;padding:20px;text-align:center;margin-bottom:20px;">
      <div style="font-size:13px;color:var(--muted);margin-bottom:6px;">You Earned</div>
      <div id="earnedVal" style="font-family:'Syne',sans-serif;font-size:40px;font-weight:800;color:var(--g)">â‚¹--</div>
    </div>
    <button class="verify-btn" onclick="finishRide()">Continue â†’</button>
  </div>
</div>

<script>
const DRIVERS = {
  vikram: {name:'Vikram Kumar',vehicle:'EW-1234',phone:'+919876543210',rating:4.8,init:'VK'},
  rajesh: {name:'Rajesh Singh',vehicle:'EW-2345',phone:'+919876543211',rating:4.7,init:'RS'},
  priya:  {name:'Priya Sharma',vehicle:'EW-3456',phone:'+919876543212',rating:4.9,init:'PS'},
  amit:   {name:'Amit Verma',vehicle:'EW-4567',phone:'+919876543213',rating:4.6,init:'AV'},
};
const PASS = {vikram:'vikram123',rajesh:'rajesh123',priya:'priya123',amit:'amit123'};

let drv = null;
let online = true;
let mode = 'app'; // app | street
let currentRide = null;
let rides = 0, earnings = 0;
let otpPhase = 'start'; // start | end

// â”€â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doLogin() {
  const sel = document.getElementById('driverSel').value;
  const pass = document.getElementById('driverPass').value;
  const err = document.getElementById('errBox');
  err.style.display = 'none';

  if (!sel) { err.textContent = 'âŒ Please select your name'; err.style.display = 'block'; return; }
  if (!pass) { err.textContent = 'âŒ Please enter password'; err.style.display = 'block'; return; }
  if (PASS[sel] !== pass) { err.textContent = 'âŒ Wrong password. Try: ' + PASS[sel]; err.style.display = 'block'; return; }

  drv = DRIVERS[sel];
  document.getElementById('loginWrap').style.display = 'none';
  document.getElementById('dashboard').style.display = 'block';
  document.getElementById('headerActions').innerHTML = `<button class="logout-btn" onclick="doLogout()">Logout</button>`;

  document.getElementById('dAvatar').textContent = drv.init;
  document.getElementById('dName').textContent = drv.name;
  document.getElementById('dMeta').textContent = drv.vehicle + ' Â· â­ ' + drv.rating;
  document.getElementById('dRating').textContent = drv.rating;

  pushToOnline();
  checkForRides();
}

function doLogout() {
  removeFromOnline();
  drv = null;
  document.getElementById('dashboard').style.display = 'none';
  document.getElementById('loginWrap').style.display = 'flex';
  document.getElementById('headerActions').innerHTML = '';
  document.getElementById('driverPass').value = '';
  document.getElementById('driverSel').value = '';
}

// â”€â”€â”€ ONLINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleOnline() {
  online = !online;
  document.getElementById('onlineSwitch').classList.toggle('on', online);
  document.getElementById('tTitle').textContent = online ? "You're Online" : "You're Offline";
  document.getElementById('tSub').textContent = online ? 'Ready to accept rides' : 'Not accepting rides';
  if (online) { pushToOnline(); checkForRides(); }
  else { removeFromOnline(); showEmpty(); }
}

function setMode(m) {
  mode = m;
  document.getElementById('m-app').classList.toggle('active', m==='app');
  document.getElementById('m-street').classList.toggle('active', m==='street');
  if (online) { pushToOnline(); checkForRides(); }
}

function pushToOnline() {
  if (!drv || !online || mode !== 'app') return;
  let list = JSON.parse(localStorage.getItem('onlineDrivers') || '[]').filter(d => d.name !== drv.name);
  list.push({name:drv.name,vehicle:drv.vehicle,phone:drv.phone,rating:drv.rating,ts:Date.now()});
  localStorage.setItem('onlineDrivers', JSON.stringify(list));
}

function removeFromOnline() {
  if (!drv) return;
  let list = JSON.parse(localStorage.getItem('onlineDrivers') || '[]').filter(d => d.name !== drv.name);
  localStorage.setItem('onlineDrivers', JSON.stringify(list));
}

// â”€â”€â”€ RIDE LOGIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkForRides() {
  if (!drv || !online) return;

  if (mode === 'street') {
    document.getElementById('rideSection').innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">ğŸš—</div>
        <div class="empty-title">Street Mode Active</div>
        <div class="empty-sub">Accept walk-in passengers directly.<br>Switch to App Mode for digital bookings.</div>
      </div>`;
    return;
  }

  const raw = localStorage.getItem('currentRide');
  if (!raw) { showEmpty(); return; }

  const ride = JSON.parse(raw);

  // Already handling this ride
  if (ride.acceptedBy === drv.name) {
    currentRide = ride;
    showRideNav(ride);
    return;
  }

  // New ride available
  if (ride.status === 'pending' && !ride.acceptedBy) {
    currentRide = ride;
    showNewRide(ride);
  } else {
    showEmpty();
  }
}

function showEmpty() {
  document.getElementById('rideSection').innerHTML = `
    <div class="empty-state">
      <div class="empty-icon">ğŸ”</div>
      <div class="empty-title">Waiting for rides...</div>
      <div class="empty-sub">New requests will appear here automatically</div>
    </div>`;
}

function showNewRide(ride) {
  document.getElementById('rideSection').innerHTML = `
    <div class="ride-request">
      <div>
        <span class="new-badge">ğŸ”” New Ride</span>
        <span class="type-badge">${({shared:'ğŸ‘¥ Shared',private:'ğŸ›º Private',family:'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Family'})[ride.rideType] || 'ğŸ›º Private'}</span>
      </div>
      <div class="cust-row">
        <img class="cust-avatar" src="${ride.customerPicture||''}" onerror="this.src='data:image/svg+xml,<svg xmlns=\'http://www.w3.org/2000/svg\'><rect width=\'44\' height=\'44\' rx=\'22\' fill=\'%2300FFB2\'/><text x=\'22\' y=\'28\' text-anchor=\'middle\' fill=\'%23080F17\' font-size=\'16\' font-weight=\'bold\'>${ride.customerName?ride.customerName[0]:'?'}</text></svg>'">
        <div>
          <div class="cust-name">${ride.customerName || 'Customer'}</div>
          <div class="cust-phone">${ride.customerPhone}</div>
        </div>
      </div>
      <div class="loc-block">
        <div class="loc-row"><div class="loc-icon">ğŸ“</div><div><div class="loc-lbl">Pickup</div><div class="loc-addr">${ride.pickup}</div></div></div>
        <div class="loc-row"><div class="loc-icon">ğŸ¯</div><div><div class="loc-lbl">Drop-off</div><div class="loc-addr">${ride.drop}</div></div></div>
      </div>
      <div class="fare-big">
        <div class="fare-big-val">${ride.fare}</div>
        <div class="fare-big-sub">You earn ${Math.round(parseInt(ride.fare.replace('â‚¹',''))*0.8)} (80%)</div>
      </div>
      <div class="action-row">
        <button class="btn-base btn-decline" onclick="declineRide()">Decline</button>
        <button class="btn-base btn-accept" onclick="acceptRide()">Accept Ride âœ“</button>
      </div>
    </div>`;
}

function acceptRide() {
  const raw = localStorage.getItem('currentRide');
  if (!raw) return;
  const ride = JSON.parse(raw);
  // Check it's still unaccepted
  if (ride.acceptedBy) { showEmpty(); return; }
  ride.acceptedBy = drv.name;
  ride.acceptedByVehicle = drv.vehicle;
  ride.acceptedByPhone = drv.phone;
  ride.acceptedByRating = drv.rating;
  ride.status = 'accepted';
  localStorage.setItem('currentRide', JSON.stringify(ride));
  currentRide = ride;
  showRideNav(ride);
}

function declineRide() { currentRide = null; showEmpty(); }

function showRideNav(ride) {
  const sec = document.getElementById('rideSection');

  if (!ride.driverAtPickup) {
    sec.innerHTML = `
      <div class="nav-active">
        <div class="nav-phase">ğŸ“ Phase 1 â€” Navigate to Pickup</div>
        <div class="nav-dest">
          <div class="nav-dest-icon">ğŸ“</div>
          <div><div class="nav-dest-lbl">Pickup Location</div><div class="nav-dest-addr">${ride.pickup}</div></div>
        </div>
        <button class="maps-btn" onclick="openMaps('${encodeURIComponent(ride.pickup)}')">ğŸ—ºï¸ Open Google Maps Navigation</button>
        <button class="nav-btn" onclick="arrivedPickup()">âœ… I've Arrived at Pickup</button>
        <button class="call-btn" onclick="callCust()">ğŸ“ Call Customer â€” ${ride.customerPhone}</button>
      </div>`;

  } else if (!ride.rideStarted) {
    const otpReady = ride.startOTPGenerated;
    sec.innerHTML = `
      <div class="nav-active">
        <div class="nav-phase">â³ Phase 2 â€” Waiting at Pickup</div>
        <div class="cust-row" style="margin-bottom:16px;">
          <img class="cust-avatar" src="${ride.customerPicture||''}" onerror="this.src='data:image/svg+xml,<svg xmlns=\'http://www.w3.org/2000/svg\'><rect width=\'44\' height=\'44\' rx=\'22\' fill=\'%2300FFB2\'/><text x=\'22\' y=\'28\' text-anchor=\'middle\' fill=\'%23080F17\' font-size=\'16\' font-weight=\'bold\'>${ride.customerName?ride.customerName[0]:'?'}</text></svg>'">
          <div><div class="cust-name">${ride.customerName}</div><div class="cust-phone">Waiting for Start OTP</div></div>
        </div>
        ${otpReady ? `<button class="nav-btn" onclick="showEnterOTP('start')">ğŸ” Enter Start OTP</button>` : `
        <div class="wait-pill">
          <div class="wait-text">â³ Waiting for Customer OTP</div>
          <div class="wait-sub">Ask customer to tap "Generate Start OTP" in their app</div>
        </div>
        <button class="nav-btn" style="background:rgba(0,255,178,0.1);color:var(--g);border:1.5px solid var(--g);" onclick="checkStartOTP()">Customer Generated OTP â†’</button>
        `}
        <button class="call-btn" onclick="callCust()" style="margin-top:10px;">ğŸ“ Call Customer â€” ${ride.customerPhone}</button>
      </div>`;

  } else if (!ride.driverAtDrop) {
    sec.innerHTML = `
      <div class="nav-active">
        <div class="nav-phase">ğŸš€ Phase 3 â€” Navigate to Drop-off</div>
        <div class="nav-dest">
          <div class="nav-dest-icon">ğŸ¯</div>
          <div><div class="nav-dest-lbl">Drop-off Location</div><div class="nav-dest-addr">${ride.drop}</div></div>
        </div>
        <button class="maps-btn" onclick="openMaps('${encodeURIComponent(ride.drop)}')">ğŸ—ºï¸ Open Google Maps Navigation</button>
        <button class="nav-btn" onclick="arrivedDrop()">ğŸ Arrived at Destination</button>
        <button class="call-btn" onclick="callCust()">ğŸ“ Call Customer</button>
      </div>`;

  } else {
    const otpReady = ride.endOTPGenerated;
    sec.innerHTML = `
      <div class="nav-active">
        <div class="nav-phase">ğŸ Phase 4 â€” Complete Ride</div>
        <div style="background:var(--bg3);border-radius:14px;padding:16px;margin-bottom:16px;text-align:center;">
          <div style="font-size:13px;color:var(--muted);margin-bottom:4px;">Destination Reached</div>
          <div style="font-size:17px;font-weight:700;">${ride.drop}</div>
        </div>
        ${otpReady ? `<button class="nav-btn" onclick="showEnterOTP('end')">ğŸ Enter End OTP to Complete</button>` : `
        <div class="wait-pill">
          <div class="wait-text">â³ Waiting for End OTP</div>
          <div class="wait-sub">Ask customer to generate End OTP in their app</div>
        </div>
        <button class="nav-btn" style="background:rgba(0,255,178,0.1);color:var(--g);border:1.5px solid var(--g);" onclick="checkEndOTP()">Customer Generated OTP â†’</button>
        `}
        <button class="call-btn" onclick="callCust()" style="margin-top:10px;">ğŸ“ Call Customer</button>
      </div>`;
  }
}

function openMaps(addr) {
  window.open(`https://www.google.com/maps/search/?api=1&query=${addr}`, '_blank');
}

function callCust() {
  if (currentRide?.customerPhone) window.location.href = 'tel:' + currentRide.customerPhone;
}

function arrivedPickup() {
  const ride = JSON.parse(localStorage.getItem('currentRide'));
  ride.driverAtPickup = true;
  localStorage.setItem('currentRide', JSON.stringify(ride));
  currentRide = ride;
  showRideNav(ride);
}

function checkStartOTP() {
  const ride = JSON.parse(localStorage.getItem('currentRide'));
  if (ride.startOTPGenerated) {
    currentRide = ride;
    showEnterOTP('start');
  } else {
    showRideNav(ride);
    alert('Customer has not generated OTP yet. Please ask them.');
  }
}

function showEnterOTP(phase) {
  otpPhase = phase;
  document.getElementById('otpInput').value = '';
  if (phase === 'start') {
    document.getElementById('otpIcon').textContent = 'ğŸ”';
    document.getElementById('otpTitle').textContent = 'Enter Start OTP';
    document.getElementById('otpSub').textContent = 'Enter the 4-digit Start OTP shown on customer\'s app';
  } else {
    document.getElementById('otpIcon').textContent = 'ğŸ';
    document.getElementById('otpTitle').textContent = 'Enter End OTP';
    document.getElementById('otpSub').textContent = 'Enter the 4-digit End OTP shown on customer\'s app';
  }
  document.getElementById('otpEnterOverlay').classList.add('show');
}

function verifyOTP() {
  const entered = document.getElementById('otpInput').value.trim();
  const ride = JSON.parse(localStorage.getItem('currentRide'));

  if (otpPhase === 'start') {
    if (!ride.startOTP) { alert('OTP not yet generated by customer'); return; }
    if (entered !== ride.startOTP) { alert('âŒ Wrong OTP! Try again.'); document.getElementById('otpInput').value=''; return; }
    ride.rideStarted = true;
    localStorage.setItem('currentRide', JSON.stringify(ride));
    currentRide = ride;
    document.getElementById('otpEnterOverlay').classList.remove('show');
    showRideNav(ride);

  } else {
    if (!ride.endOTP) { alert('OTP not yet generated by customer'); return; }
    if (entered !== ride.endOTP) { alert('âŒ Wrong OTP! Try again.'); document.getElementById('otpInput').value=''; return; }
    document.getElementById('otpEnterOverlay').classList.remove('show');
    document.getElementById('payAmount').textContent = ride.fare;
    document.getElementById('payOverlay').classList.add('show');
  }
}

function arrivedDrop() {
  const ride = JSON.parse(localStorage.getItem('currentRide'));
  ride.driverAtDrop = true;
  localStorage.setItem('currentRide', JSON.stringify(ride));
  currentRide = ride;
  showRideNav(ride);
}

function checkEndOTP() {
  const ride = JSON.parse(localStorage.getItem('currentRide'));
  if (ride.endOTPGenerated) {
    currentRide = ride;
    showEnterOTP('end');
  } else {
    showRideNav(ride);
    alert('Customer has not generated End OTP yet. Please ask them.');
  }
}

function selPay(el) { document.querySelectorAll('.pay-opt').forEach(o=>o.classList.remove('sel')); el.classList.add('sel'); }

function confirmPayment() {
  const ride = JSON.parse(localStorage.getItem('currentRide'));
  const total = parseInt(ride.fare.replace('â‚¹',''));
  const earned = Math.round(total * 0.8);

  ride.completed = true;
  ride.status = 'completed';
  delete ride.customerPhone;
  delete ride.customerEmail;
  delete ride.customerName;
  delete ride.customerPicture;
  localStorage.setItem('currentRide', JSON.stringify(ride));

  rides++; earnings += earned;
  document.getElementById('dRides').textContent = rides;
  document.getElementById('dEarnings').textContent = earnings;

  document.getElementById('payOverlay').classList.remove('show');
  document.getElementById('earnedVal').textContent = 'â‚¹' + earned;
  document.getElementById('doneOverlay').classList.add('show');
}

function finishRide() {
  document.getElementById('doneOverlay').classList.remove('show');
  localStorage.removeItem('currentRide');
  currentRide = null;
  showEmpty();
}

// â”€â”€â”€ POLLING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
setInterval(() => {
  if (drv && online && mode === 'app') {
    pushToOnline();
    if (!currentRide) checkForRides();
    else {
      // Refresh ride state
      const raw = localStorage.getItem('currentRide');
      if (raw) {
        const r = JSON.parse(raw);
        if (r.acceptedBy === drv.name) {
          const changed = JSON.stringify(r) !== JSON.stringify(currentRide);
          if (changed) { currentRide = r; showRideNav(r); }
        }
      }
    }
  }
}, 2000);
</script>
</body>
</html>
